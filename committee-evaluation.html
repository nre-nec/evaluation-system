<!doctype html>
<html lang="ar" dir="rtl">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>تقييم اللجنة | Committee Evaluation</title>
<link rel="stylesheet" href="assets/style.css"></head>
<body>
<header class="header">
  <div class="brand"><img src="logo.png"><h1>تقييم اللجنة <span class="badge">Committee</span></h1></div>
  <div class="actions"><span class="user">المستخدم: <b id="who"></b></span><button class="ghost" onclick="logout()">تسجيل خروج</button></div>
</header>
<div class="container">
  <div class="card">
    <h3>اختيار المتقدم <span class="badge">Select applicant</span></h3>
    <div class="grid">
      <div><label>المتقدم</label><select id="appSel" class="input"></select></div>
      <div><label>العام الجامعي</label><input id="year" class="input" placeholder="2025/2026"></div>
    </div>
  </div>
  <div class="card">
    <h3>نموذج التقييم <span class="badge">Evaluation form</span></h3>
    <div class="grid">
      <div><label>المعيار 1 (0-40)</label><input type="number" id="q1" class="input" min="0" max="40" value="0"></div>
      <div><label>المعيار 2 (0-30)</label><input type="number" id="q2" class="input" min="0" max="30" value="0"></div>
      <div><label>المعيار 3 (0-20)</label><input type="number" id="q3" class="input" min="0" max="20" value="0"></div>
      <div><label>المعيار 4 (0-10)</label><input type="number" id="q4" class="input" min="0" max="10" value="0"></div>
    </div>
    <div style="margin-top:12px"><label>ملاحظات</label><textarea id="remarks" class="input" rows="3"></textarea></div>
    <div class="actions" style="margin-top:12px">
      <button id="save">حفظ التقييم | Save</button><span style="align-self:center">المجموع: <b id="total">0</b> / 100</span>
    </div>
  </div>
  <div class="card">
    <h3>تقييماتي السابقة <span class="badge">My evaluations</span></h3>
    <table class="table" id="tblMine"><thead><tr><th>المتقدم</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th><th>المجموع</th><th>الوقت</th></tr></thead><tbody></tbody></table>
  </div>
</div>
<script src="assets/app.js"></script>
<script>
const s = ensureAuth(); if(s) document.getElementById('who').textContent=s.user.username;
let myCommittee = s?.user?.committee || '';
let allApps = [], mine = [];

function calc(){
  const t=(+document.getElementById('q1').value||0)+(+document.getElementById('q2').value||0)+(+document.getElementById('q3').value||0)+(+document.getElementById('q4').value||0);
  document.getElementById('total').textContent=t; return t;
}
document.addEventListener('input',e=>{ if(['q1','q2','q3','q4'].includes(e.target.id)) calc(); });

(async ()=>{
  try{ allApps = await apiGet('applicants'); const evals = await apiGet('evaluations');
    const list = allApps.filter(a=>a.visible===true && (!myCommittee || (a.committee||'')==myCommittee));
    const sel=document.getElementById('appSel'); sel.innerHTML=list.map(a=>`<option value="${a.id}">${a.name} — ${a.department||''}</option>`).join('');
    mine = evals.filter(r=>r.evaluatorName===s.user.username);
    const body=document.querySelector('#tblMine tbody'); body.innerHTML = mine.map(r=>`<tr><td>${r.applicantId}</td><td>${r.scores?.q1||0}</td><td>${r.scores?.q2||0}</td><td>${r.scores?.q3||0}</td><td>${r.scores?.q4||0}</td><td>${r.total||0}</td><td>${r.timestamp||''}</td></tr>`).join('');
  }catch(e){ toast('تعذر تحميل البيانات','err'); }
})();

document.getElementById('save').addEventListener('click', async ()=>{
  const payload = {
    applicantId: document.getElementById('appSel').value,
    evaluatorName: s.user.username,
    committee: myCommittee,
    year: document.getElementById('year').value || '',
    scores: {q1:+document.getElementById('q1').value||0, q2:+document.getElementById('q2').value||0, q3:+document.getElementById('q3').value||0, q4:+document.getElementById('q4').value||0},
    total: calc(),
    remarks: document.getElementById('remarks').value.trim(),
    timestamp: new Date().toISOString()
  };
  try{ await apiPost('evaluations', payload); toast('تم الحفظ بنجاح ✅','success'); }
  catch(e){ toast('فشل الحفظ (تأكد من صلاحيات الـ Worker) ❌','err'); }
});
</script>
</body></html>
